<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCB Clone - Real Banking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        .pulse-soft { animation: pulse 2s infinite; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bank-gradient {
            background: linear-gradient(135deg, #7C3AED 0%, #4F46E5 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Updated Virtual Card with Electric Border Animation - Matching image 1st */
        .virtual-card {
            background: #1a1a1a;
            border-radius: 16px;
            color: white;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .electric-border {
            position: relative;
            border-radius: 16px;
            background: linear-gradient(45deg, #ff0080, #00ff88, #0080ff, #ff0080);
            background-size: 400% 400%;
            animation: electricFlow 3s ease infinite;
            padding: 2px;
        }

        .electric-border::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff0080, #00ff88, #0080ff, #ff0080);
            background-size: 400% 400%;
            border-radius: 18px;
            animation: electricFlow 3s ease infinite;
            z-index: -1;
            filter: blur(10px);
            opacity: 0.7;
        }

        @keyframes electricFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .virtual-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
        }

        /* New Card Design - Matching image 2nd (image.png) */
        .new-card-design {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            color: white;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .new-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .new-card-balance {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .new-card-body {
            flex: 1;
        }

        .new-card-field {
            margin-bottom: 15px;
        }

        .new-card-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: block;
        }

        .new-card-value {
            font-size: 16px;
            font-weight: 600;
            color: white;
            display: block;
        }

        .new-card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 8px;
        }

        .new-card-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .new-card-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .card-number-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .otp-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            margin: 0 4px;
        }

        .otp-input:focus {
            border-color: #7C3AED;
            outline: none;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .transaction-item {
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background-color: #f9fafb;
            transform: translateX(4px);
        }

        .organization-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            transition: all 0.3s ease;
        }

        .organization-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav id="navbar" class="bg-white shadow-lg sticky top-0 z-40 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-piggy-bank text-2xl text-purple-600 mr-3"></i>
                        <span class="text-xl font-bold text-gray-900">HCB Clone</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4" id="navButtons">
                    <!-- Navigation buttons populated by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="min-h-screen">
        <!-- Content will be dynamically loaded here -->
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-gray-600 loading-dots">Processing</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50 max-w-sm"></div>

    <script>
        // Global Application State
        const AppState = {
            user: null,
            token: localStorage.getItem('authToken'),
            socket: null,
            currentBalance: 0,
            account: null,
            transactions: [],
            cards: [],
            organizations: [],
            loginData: null,
            currentView: 'dashboard'
        };

        // DOM Elements
        const elements = {
            mainContent: document.getElementById('mainContent'),
            navButtons: document.getElementById('navButtons'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            toastContainer: document.getElementById('toastContainer')
        };

        // Utility Functions
        const Utils = {
            showLoading() {
                elements.loadingOverlay.classList.remove('hidden');
            },

            hideLoading() {
                elements.loadingOverlay.classList.add('hidden');
            },

            showToast(message, type = 'info') {
                const bgColor = {
                    error: 'bg-red-500',
                    success: 'bg-green-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                }[type];

                const toast = document.createElement('div');
                toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 slide-up flex items-center justify-between`;
                
                toast.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                elements.toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.transform = 'translateX(100%)';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            },

            formatCurrency(amountCents) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amountCents / 100);
            },

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            generateIdempotencyKey() {
                return `idemp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            },

            maskCardNumber(cardNumber) {
                return '•••• •••• •••• ' + cardNumber.slice(-4);
            },

            formatCardDate(month, year) {
                return `${month.toString().padStart(2, '0')}/${year.toString().slice(-2)}`;
            },

            validateCardNumber(cardNumber) {
                // Luhn algorithm validation
                if (!/^\d+$/.test(cardNumber) || cardNumber.length < 13 || cardNumber.length > 19) {
                    return false;
                }

                let sum = 0;
                let isEven = false;
                
                for (let i = cardNumber.length - 1; i >= 0; i--) {
                    let digit = parseInt(cardNumber[i]);
                    
                    if (isEven) {
                        digit *= 2;
                        if (digit > 9) digit -= 9;
                    }
                    
                    sum += digit;
                    isEven = !isEven;
                }
                
                return sum % 10 === 0;
            },

            validateCVV(cvv) {
                return /^\d{3,4}$/.test(cvv);
            },

            validateExpiry(month, year) {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                if (year < currentYear) return false;
                if (year === currentYear && month < currentMonth) return false;
                if (month < 1 || month > 12) return false;
                
                return true;
            }
        };

        // API Service
        const ApiService = {
            async request(endpoint, options = {}) {
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(AppState.token && { 'Authorization': `Bearer ${AppState.token}` })
                    },
                    ...options
                };

                if (options.body) {
                    config.body = JSON.stringify(options.body);
                }

                try {
                    const response = await fetch(endpoint, config);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    }
                    
                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            },

            async get(endpoint) {
                return this.request(endpoint);
            },

            async post(endpoint, body) {
                return this.request(endpoint, { method: 'POST', body });
            },

            async put(endpoint, body) {
                return this.request(endpoint, { method: 'PUT', body });
            },

            async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }
        };

        // Auth Management
        const AuthManager = {
            renderAuthScreen() {
                const authHTML = `
                    <div class="min-h-screen bank-gradient flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                        <div class="max-w-md w-full space-y-8 bg-white rounded-2xl shadow-xl p-8 slide-up">
                            <div class="text-center">
                                <i class="fas fa-piggy-bank text-4xl text-purple-600 mb-4"></i>
                                <h2 class="text-3xl font-bold text-gray-900" id="authTitle">Welcome to HCB Clone</h2>
                                <p class="mt-2 text-gray-600">Choose how you'd like to sign in</p>
                            </div>
                            
                            <!-- Tab Navigation -->
                            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                                <button id="loginTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-all duration-200 bg-white text-purple-600 shadow-sm">
                                    I have an account
                                </button>
                                <button id="signupTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-all duration-200 text-gray-600 hover:text-gray-900">
                                    Create account
                                </button>
                            </div>

                            <!-- Login Form -->
                            <form class="mt-6 space-y-6" id="loginForm">
                                <div>
                                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                    <input id="loginEmail" name="email" type="email" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200"
                                           placeholder="your@email.com">
                                </div>

                                <div>
                                    <button type="submit"
                                            class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 transform hover:scale-105">
                                        <span>Continue to OTP</span>
                                    </button>
                                </div>
                            </form>

                            <!-- Signup Form -->
                            <form class="mt-6 space-y-6 hidden" id="signupForm">
                                <div class="space-y-4">
                                    <div>
                                        <label for="signupEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                        <input id="signupEmail" name="email" type="email" required 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200"
                                               placeholder="your@email.com">
                                    </div>
                                    <div>
                                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input id="name" name="name" type="text" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200"
                                               placeholder="John Doe">
                                    </div>
                                    <div>
                                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone (Optional)</label>
                                        <input id="phone" name="phone" type="tel"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200"
                                               placeholder="+1 (555) 123-4567">
                                    </div>
                                </div>

                                <div>
                                    <button type="submit"
                                            class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 transform hover:scale-105">
                                        <span>Create Account</span>
                                    </button>
                                </div>
                            </form>

                            <!-- Demo Accounts Info -->
                            <div class="mt-6 p-4 bg-purple-50 rounded-lg">
                                <h4 class="text-sm font-semibold text-purple-800 mb-2">Demo Accounts:</h4>
                                <div class="text-xs text-purple-600 space-y-1">
                                    <div>• demo@hcb.com (Any OTP works)</div>
                                    <div>• user2@hcb.com (Any OTP works)</div>
                                    <div class="mt-2 text-purple-500">Or create a new account with any email</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = authHTML;
                this.setupAuthHandlers();
            },

            setupAuthHandlers() {
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                const loginTab = document.getElementById('loginTab');
                const signupTab = document.getElementById('signupTab');

                // Tab switching
                loginTab.addEventListener('click', () => {
                    loginTab.classList.add('bg-white', 'text-purple-600', 'shadow-sm');
                    loginTab.classList.remove('text-gray-600');
                    signupTab.classList.remove('bg-white', 'text-purple-600', 'shadow-sm');
                    signupTab.classList.add('text-gray-600');
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                });

                signupTab.addEventListener('click', () => {
                    signupTab.classList.add('bg-white', 'text-purple-600', 'shadow-sm');
                    signupTab.classList.remove('text-gray-600');
                    loginTab.classList.remove('bg-white', 'text-purple-600', 'shadow-sm');
                    loginTab.classList.add('text-gray-600');
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });

                // Login form submission
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    Utils.showLoading();

                    const formData = new FormData(loginForm);
                    const email = formData.get('email');

                    try {
                        const data = await ApiService.post('/api/auth/login', { email });
                        AppState.loginData = data;
                        this.renderOTPScreen();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });

                // Signup form submission
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    Utils.showLoading();

                    const formData = new FormData(signupForm);
                    const email = formData.get('email');
                    const name = formData.get('name');
                    const phone = formData.get('phone');

                    try {
                        const data = await ApiService.post('/api/auth/signup', { email, name, phone });
                        AppState.loginData = data;
                        Utils.showToast('OTP sent to your email!', 'success');
                        this.renderOTPScreen();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            renderOTPScreen() {
                const otpHTML = `
                    <div class="min-h-screen bank-gradient flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                        <div class="max-w-md w-full space-y-8 bg-white rounded-2xl shadow-xl p-8 slide-up">
                            <div class="text-center">
                                <i class="fas fa-shield-alt text-4xl text-purple-600 mb-4"></i>
                                <h2 class="text-3xl font-bold text-gray-900">Enter OTP</h2>
                                <p class="mt-2 text-gray-600">We've sent a 6-digit code to your email</p>
                                <p class="text-sm text-purple-600 font-medium mt-1">${AppState.loginData.email}</p>
                                ${AppState.loginData.email.includes('demo') ? `
                                    <div class="mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-700">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        For demo accounts, use any 6-digit OTP
                                    </div>
                                ` : ''}
                            </div>
                            
                            <form class="mt-8 space-y-6" id="otpForm">
                                <div class="flex justify-center space-x-2">
                                    <input type="text" maxlength="1" class="otp-input" data-index="1">
                                    <input type="text" maxlength="1" class="otp-input" data-index="2">
                                    <input type="text" maxlength="1" class="otp-input" data-index="3">
                                    <input type="text" maxlength="1" class="otp-input" data-index="4">
                                    <input type="text" maxlength="1" class="otp-input" data-index="5">
                                    <input type="text" maxlength="1" class="otp-input" data-index="6">
                                </div>

                                <div>
                                    <button type="submit"
                                            class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200">
                                        Verify OTP
                                    </button>
                                </div>
                                
                                <div class="text-center">
                                    <button type="button" id="resendOtp" 
                                            class="text-purple-600 hover:text-purple-500 font-medium transition-colors duration-200">
                                        Resend OTP
                                    </button>
                                    <br>
                                    <button type="button" onclick="AuthManager.renderAuthScreen()" 
                                            class="text-gray-600 hover:text-gray-500 text-sm mt-2 transition-colors duration-200">
                                        ← Back
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = otpHTML;
                this.setupOTPHandlers();
            },

            setupOTPHandlers() {
                const otpForm = document.getElementById('otpForm');
                const resendOtp = document.getElementById('resendOtp');
                const otpInputs = document.querySelectorAll('.otp-input');

                // OTP input auto-focus and navigation
                otpInputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                            otpInputs[index - 1].focus();
                        }
                    });
                });

                otpForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    Utils.showLoading();

                    const otp = Array.from(otpInputs).map(input => input.value).join('');

                    if (otp.length !== 6) {
                        Utils.showToast('Please enter the complete 6-digit OTP', 'error');
                        Utils.hideLoading();
                        return;
                    }

                    try {
                        const data = await ApiService.post('/api/auth/verify-otp', {
                            user_id: AppState.loginData.user_id,
                            otp: otp
                        });

                        AppState.token = data.token;
                        AppState.user = data.user;
                        AppState.account = data.account;
                        
                        localStorage.setItem('authToken', data.token);
                        
                        Utils.showToast('Login successful!', 'success');
                        DashboardManager.initialize();
                        
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                        // Clear OTP inputs on error
                        otpInputs.forEach(input => input.value = '');
                        otpInputs[0].focus();
                    } finally {
                        Utils.hideLoading();
                    }
                });

                resendOtp.addEventListener('click', async () => {
                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/auth/resend-otp', {
                            user_id: AppState.loginData.user_id
                        });
                        Utils.showToast('New OTP sent to your email', 'success');
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });

                // Focus first input
                otpInputs[0].focus();
            },

            logout() {
                AppState.user = null;
                AppState.token = null;
                AppState.account = null;
                AppState.currentBalance = 0;
                AppState.transactions = [];
                AppState.cards = [];
                AppState.organizations = [];
                AppState.loginData = null;
                AppState.currentView = 'dashboard';
                
                localStorage.removeItem('authToken');
                
                if (AppState.socket) {
                    AppState.socket.disconnect();
                    AppState.socket = null;
                }
                
                Utils.showToast('Logged out successfully', 'success');
                this.renderAuthScreen();
                NavigationManager.update();
            },

            async checkSession() {
                if (!AppState.token) {
                    return false;
                }

                try {
                    const response = await ApiService.get('/api/auth/check-session');
                    return response.valid;
                } catch (error) {
                    return false;
                }
            }
        };

        // Navigation Management
        const NavigationManager = {
            update() {
                if (AppState.user) {
                    elements.navButtons.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <button onclick="OrganizationManager.showOrganizations()" 
                                    class="flex items-center space-x-2 text-gray-700 hover:text-purple-600 transition-colors duration-200">
                                <i class="fas fa-building"></i>
                                <span class="hidden md:block">Organizations</span>
                            </button>
                            <span class="text-gray-700 hidden sm:block">Hello, ${AppState.user.name}</span>
                            <button onclick="DashboardManager.showProfile()" 
                                    class="flex items-center space-x-2 text-gray-700 hover:text-purple-600 transition-colors duration-200">
                                <i class="fas fa-user-circle"></i>
                                <span class="hidden md:block">Profile</span>
                            </button>
                            <button onclick="AuthManager.logout()" 
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                Logout
                            </button>
                        </div>
                    `;
                } else {
                    elements.navButtons.innerHTML = `
                        <button onclick="AuthManager.renderAuthScreen()" 
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                            Login
                        </button>
                    `;
                }
            }
        };

        // Dashboard Management
        const DashboardManager = {
            async initialize() {
                AppState.currentView = 'dashboard';
                NavigationManager.update();
                await this.loadDashboardData();
                this.renderDashboard();
                SocketManager.initialize();
            },

            async loadDashboardData() {
                Utils.showLoading();
                try {
                    // Load profile and account data
                    const profileData = await ApiService.get('/api/profile');
                    AppState.user = profileData.user;
                    AppState.account = profileData.account;
                    AppState.currentBalance = profileData.account?.balance_cents || 0;

                    // Load transactions
                    const transactionsData = await ApiService.get('/api/account/transactions');
                    AppState.transactions = transactionsData.transactions;

                    // Load cards
                    const cardsData = await ApiService.get('/api/cards');
                    AppState.cards = cardsData.cards;

                    // Load organizations
                    const organizationsData = await ApiService.get('/api/organizations');
                    AppState.organizations = organizationsData.organizations;

                } catch (error) {
                    Utils.showToast('Failed to load dashboard data', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            renderDashboard() {
                const dashboardHTML = `
                    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 fade-in">
                        <div class="px-4 py-6 sm:px-0">
                            <!-- Welcome Banner -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-900">Welcome back, ${AppState.user.name}!</h1>
                                        <p class="text-gray-600 mt-1">Here's your financial overview</p>
                                        <p class="text-sm text-green-600 mt-2">✓ Session valid for 3 days</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        ${AppState.user.profile_picture ? 
                                            `<img src="${AppState.user.profile_picture}" class="w-12 h-12 rounded-full border-2 border-purple-200">` :
                                            `<div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center border-2 border-purple-200">
                                                <i class="fas fa-user text-purple-600 text-xl"></i>
                                            </div>`
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Account Balance Card -->
                            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6 card-hover">
                                <div class="bank-gradient px-6 py-8 text-white">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-purple-200 text-sm">Account Balance</p>
                                            <h2 class="text-4xl font-bold mt-2" id="balanceDisplay">
                                                ${Utils.formatCurrency(AppState.currentBalance)}
                                            </h2>
                                            <p class="text-purple-200 text-sm mt-2">Account: ${AppState.account?.account_number || 'N/A'}</p>
                                            ${AppState.account?.routing_number ? `<p class="text-purple-200 text-sm">Routing: ${AppState.account.routing_number}</p>` : ''}
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                                            <i class="fas fa-wallet text-2xl"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <button onclick="DashboardManager.showDepositModal()" 
                                                class="flex items-center justify-center space-x-2 bg-green-50 text-green-700 px-4 py-3 rounded-lg hover:bg-green-100 transition-colors duration-200">
                                            <i class="fas fa-arrow-down"></i>
                                            <span>Deposit</span>
                                        </button>
                                        <button onclick="DashboardManager.showTransferModal()" 
                                                class="flex items-center justify-center space-x-2 bg-blue-50 text-blue-700 px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors duration-200">
                                            <i class="fas fa-exchange-alt"></i>
                                            <span>Transfer</span>
                                        </button>
                                        <button onclick="CardManager.showCreateCardModal()" 
                                                class="flex items-center justify-center space-x-2 bg-purple-50 text-purple-700 px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors duration-200">
                                            <i class="fas fa-credit-card"></i>
                                            <span>Get Card</span>
                                        </button>
                                        <button onclick="PaymentManager.showPaymentModal()" 
                                                class="flex items-center justify-center space-x-2 bg-orange-50 text-orange-700 px-4 py-3 rounded-lg hover:bg-orange-100 transition-colors duration-200">
                                            <i class="fas fa-shopping-cart"></i>
                                            <span>Make Payment</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Content Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Transactions Section -->
                                <div class="lg:col-span-2">
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3>
                                                <button onclick="DashboardManager.showAllTransactions()" 
                                                        class="text-purple-600 hover:text-purple-500 text-sm font-medium">
                                                    View All
                                                </button>
                                            </div>
                                        </div>
                                        <div class="divide-y divide-gray-200 min-h-[400px]" id="transactionsList">
                                            ${this.renderTransactions()}
                                        </div>
                                    </div>
                                </div>

                                <!-- Cards & Organizations Section -->
                                <div class="space-y-8">
                                    <!-- Cards Section -->
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <h3 class="text-lg font-semibold text-gray-900">Virtual Cards</h3>
                                                <button onclick="CardManager.showCreateCardModal()" 
                                                        class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors duration-200">
                                                    + New Card
                                                </button>
                                            </div>
                                        </div>
                                        <div class="p-6" id="cardsList">
                                            ${this.renderCards()}
                                        </div>
                                    </div>

                                    <!-- Organizations Section -->
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <h3 class="text-lg font-semibold text-gray-900">My Organizations</h3>
                                                <button onclick="OrganizationManager.showCreateOrganizationModal()" 
                                                        class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors duration-200">
                                                    + New
                                                </button>
                                            </div>
                                        </div>
                                        <div class="p-6" id="organizationsList">
                                            ${this.renderOrganizations()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = dashboardHTML;
            },

            renderTransactions() {
                if (!AppState.transactions.length) {
                    return `
                        <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                            <i class="fas fa-receipt text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg">No transactions yet</p>
                            <p class="text-sm mt-1">Your transactions will appear here</p>
                        </div>
                    `;
                }

                return AppState.transactions.slice(0, 8).map(transaction => `
                    <div class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150 transaction-item">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0 ${transaction.amount_cents > 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} rounded-lg p-2">
                                    <i class="fas ${transaction.amount_cents > 0 ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">
                                        ${transaction.description || 'Transaction'}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ${Utils.formatDate(transaction.created_at)}
                                        ${transaction.counterparty_name ? `• ${transaction.counterparty_name}` : ''}
                                        ${transaction.counterparty_card ? `• Card ${transaction.counterparty_card}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold ${transaction.amount_cents > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${transaction.amount_cents > 0 ? '+' : ''}${Utils.formatCurrency(transaction.amount_cents)}
                                </div>
                                <div class="text-xs text-gray-500 capitalize">${transaction.status}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderCards() {
                if (!AppState.cards.length) {
                    return `
                        <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                            <i class="fas fa-credit-card text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg mb-2">No virtual cards</p>
                            <p class="text-sm text-center mb-4">Create your first virtual card for online purchases</p>
                            <button onclick="CardManager.createCard()" 
                                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                Create Virtual Card
                            </button>
                        </div>
                    `;
                }

                return AppState.cards.map(card => `
                    <div class="electric-border mb-4 card-hover" onclick="CardManager.showCardDetailsView('${card._id}')">
                        <div class="new-card-design">
                            <div class="new-card-header">
                                <div class="new-card-balance">${Utils.formatCurrency(card.balance_cents)}</div>
                            </div>
                            <div class="new-card-body">
                                <div class="new-card-field">
                                    <span class="new-card-label">Card number</span>
                                    <span class="new-card-value card-number-display">${Utils.maskCardNumber(card.card_number)}</span>
                                </div>
                                <div class="new-card-field">
                                    <span class="new-card-label">Name of the card holder</span>
                                    <span class="new-card-value">${card.card_owner || AppState.user.name}</span>
                                </div>
                                <div class="new-card-field">
                                    <span class="new-card-label">Sxpiry date</span>
                                    <span class="new-card-value">${Utils.formatCardDate(card.expiry_month, card.expiry_year)}</span>
                                </div>
                            </div>
                            <div class="new-card-actions">
                                <button onclick="event.stopPropagation(); CardManager.showFundCardModal('${card._id}')" 
                                        class="new-card-btn">
                                    Addfund
                                </button>
                                <button onclick="event.stopPropagation(); CardManager.showCardDetailsView('${card._id}')" 
                                        class="new-card-btn">
                                    Details
                                </button>
                                <button onclick="event.stopPropagation(); CardManager.showUpdateOwnerModal('${card._id}')" 
                                        class="new-card-btn">
                                    Edit card
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderOrganizations() {
                if (!AppState.organizations.length) {
                    return `
                        <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                            <i class="fas fa-building text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg mb-2">No organizations</p>
                            <p class="text-sm text-center mb-4">Create or join an organization to manage finances together</p>
                            <button onclick="OrganizationManager.showCreateOrganizationModal()" 
                                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                Create Organization
                            </button>
                        </div>
                    `;
                }

                return AppState.organizations.slice(0, 3).map(org => `
                    <div class="organization-card p-4 mb-3" onclick="OrganizationManager.showOrganizationDetails('${org._id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold text-lg">${org.name}</div>
                                <div class="text-sm opacity-80 mt-1">${org.description || 'No description'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm opacity-80">${org.members.length} members</div>
                                <div class="text-xs mt-1">${org.owner_id === AppState.user._id ? 'Owner' : 'Member'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            showAllTransactions() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden slide-up">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-gray-900">All Transactions</h3>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="overflow-y-auto max-h-[60vh]">
                            <div class="divide-y divide-gray-200">
                                ${AppState.transactions.map(transaction => `
                                    <div class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-4">
                                                <div class="flex-shrink-0 ${transaction.amount_cents > 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} rounded-lg p-2">
                                                    <i class="fas ${transaction.amount_cents > 0 ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                                </div>
                                                <div>
                                                    <div class="font-medium text-gray-900">
                                                        ${transaction.description || 'Transaction'}
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        ${Utils.formatDate(transaction.created_at)}
                                                        ${transaction.counterparty_name ? `• ${transaction.counterparty_name}` : ''}
                                                        ${transaction.counterparty_card ? `• Card ${transaction.counterparty_card}` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold ${transaction.amount_cents > 0 ? 'text-green-600' : 'text-red-600'}">
                                                    ${transaction.amount_cents > 0 ? '+' : ''}${Utils.formatCurrency(transaction.amount_cents)}
                                                </div>
                                                <div class="text-xs text-gray-500 capitalize">${transaction.status}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            showDepositModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Deposit Funds</h3>
                        </div>
                        <form id="depositForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                                <input type="text"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="e.g., Initial deposit">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Deposit
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#depositForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amount = parseFloat(e.target.querySelector('input[type="number"]').value);
                    const description = e.target.querySelector('input[type="text"]').value;

                    if (amount <= 0) {
                        Utils.showToast('Please enter a valid amount', 'error');
                        return;
                    }

                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/account/deposit', {
                            amount_cents: Math.round(amount * 100),
                            description: description || 'Account deposit'
                        });

                        Utils.showToast('Deposit successful!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        DashboardManager.renderDashboard();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            showTransferModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Send Money</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 gap-4">
                                <button onclick="this.closest('.fixed').remove(); DashboardManager.showInternalTransferModal()" 
                                        class="flex items-center space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-200 text-left">
                                    <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user-friends text-blue-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">Send to HCB User</div>
                                        <div class="text-sm text-gray-500">Instant transfer to another HCB account</div>
                                    </div>
                                </button>
                                
                                <button onclick="this.closest('.fixed').remove(); TransferManager.showExternalTransferModal()" 
                                        class="flex items-center space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-200 text-left">
                                    <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-building text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">External Transfer</div>
                                        <div class="text-sm text-gray-500">Send to any US bank account</div>
                                    </div>
                                </button>

                                <button onclick="this.closest('.fixed').remove(); TransferManager.showCardToBankTransferModal()" 
                                        class="flex items-center space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-200 text-left">
                                    <div class="flex-shrink-0 w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-credit-card text-purple-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">Card to Bank Transfer</div>
                                        <div class="text-sm text-gray-500">Transfer from card to bank account</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            showInternalTransferModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Send to HCB User</h3>
                        </div>
                        <form id="internalTransferForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Email</label>
                                <input type="email" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="recipient@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                                <input type="text"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="e.g., Payment for services">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Send Money
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#internalTransferForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const recipient_email = e.target.querySelector('input[type="email"]').value;
                    const amount = parseFloat(e.target.querySelector('input[type="number"]').value);
                    const description = e.target.querySelector('input[type="text"]').value;

                    if (amount <= 0) {
                        Utils.showToast('Please enter a valid amount', 'error');
                        return;
                    }

                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/account/transfer', {
                            amount_cents: Math.round(amount * 100),
                            recipient_email: recipient_email,
                            description: description || `Transfer to ${recipient_email}`
                        });

                        Utils.showToast('Transfer successful!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        DashboardManager.renderDashboard();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            async showProfile() {
                Utils.showLoading();
                try {
                    const profileData = await ApiService.get('/api/profile');
                    AppState.user = profileData.user;
                    
                    const profileHTML = `
                        <div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8 fade-in">
                            <div class="px-4 py-6 sm:px-0">
                                <!-- Profile Header -->
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h1 class="text-2xl font-bold text-gray-900">Profile Settings</h1>
                                            <p class="text-gray-600 mt-1">Manage your account information</p>
                                        </div>
                                        <button onclick="DashboardManager.initialize()" 
                                                class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                                            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                                        </button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <!-- Profile Picture & Basic Info -->
                                    <div class="lg:col-span-1">
                                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                            <div class="text-center">
                                                ${AppState.user.profile_picture ? 
                                                    `<img src="${AppState.user.profile_picture}" class="w-32 h-32 rounded-full mx-auto border-4 border-purple-200 mb-4">` :
                                                    `<div class="w-32 h-32 bg-purple-100 rounded-full flex items-center justify-center border-4 border-purple-200 mx-auto mb-4">
                                                        <i class="fas fa-user text-purple-600 text-4xl"></i>
                                                    </div>`
                                                }
                                                <h3 class="text-xl font-semibold text-gray-900">${AppState.user.name}</h3>
                                                <p class="text-gray-600 mt-1">${AppState.user.email}</p>
                                                <div class="mt-4">
                                                    <label for="profilePictureUpload" 
                                                           class="cursor-pointer bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200 inline-block">
                                                        <i class="fas fa-camera mr-2"></i>Change Photo
                                                    </label>
                                                    <input type="file" id="profilePictureUpload" accept="image/*" class="hidden">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Profile Form -->
                                    <div class="lg:col-span-2">
                                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-6">Personal Information</h3>
                                            <form id="profileForm" class="space-y-6">
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                                        <input type="text" name="name" value="${AppState.user.name}" required
                                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                                    </div>
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                                        <input type="email" value="${AppState.user.email}" disabled
                                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                                    <input type="tel" name="phone" value="${AppState.user.phone || ''}"
                                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                           placeholder="+1 (555) 123-4567">
                                                </div>

                                                <!-- Organization Section -->
                                                <div class="border-t pt-6">
                                                    <h4 class="text-md font-semibold text-gray-900 mb-4">Organization</h4>
                                                    <div class="space-y-3">
                                                        <div>
                                                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Organization</label>
                                                            <select name="organization_id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                                                <option value="">No Organization</option>
                                                                ${AppState.organizations.map(org => `
                                                                    <option value="${org._id}" ${AppState.user.organization_id === org._id ? 'selected' : ''}>${org.name}</option>
                                                                `).join('')}
                                                            </select>
                                                        </div>
                                                        <button type="button" onclick="OrganizationManager.showCreateOrganizationModal()" 
                                                                class="text-purple-600 hover:text-purple-500 text-sm font-medium">
                                                            + Create New Organization
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="border-t pt-6">
                                                    <h4 class="text-md font-semibold text-gray-900 mb-4">Account Status</h4>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                        <div>
                                                            <span class="text-gray-600">Email Verification:</span>
                                                            <span class="ml-2 ${AppState.user.email_verified ? 'text-green-600' : 'text-yellow-600'} font-medium">
                                                                ${AppState.user.email_verified ? 'Verified' : 'Pending'}
                                                            </span>
                                                        </div>
                                                        <div>
                                                            <span class="text-gray-600">KYC Status:</span>
                                                            <span class="ml-2 ${AppState.user.kyc_status === 'verified' ? 'text-green-600' : AppState.user.kyc_status === 'rejected' ? 'text-red-600' : 'text-yellow-600'} font-medium capitalize">
                                                                ${AppState.user.kyc_status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="flex justify-end space-x-3 pt-6">
                                                    <button type="button" onclick="DashboardManager.initialize()" 
                                                            class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                                        Cancel
                                                    </button>
                                                    <button type="submit" 
                                                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                                        Save Changes
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    elements.mainContent.innerHTML = profileHTML;

                    // Setup profile form
                    document.getElementById('profileForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await ProfileManager.updateProfile(new FormData(e.target));
                    });

                } catch (error) {
                    Utils.showToast('Failed to load profile', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // Profile Management
        const ProfileManager = {
            async updateProfile(formData) {
                Utils.showLoading();
                try {
                    const updates = {
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        organization_id: formData.get('organization_id')
                    };

                    const data = await ApiService.put('/api/profile', updates);
                    AppState.user = data.user;
                    
                    Utils.showToast('Profile updated successfully!', 'success');
                    NavigationManager.update();
                    
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // Card Management
        const CardManager = {
            showCreateCardModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Create Virtual Card</h3>
                        </div>
                        <div class="p-6">
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-info-circle text-purple-600 mt-1"></i>
                                    <div class="text-sm text-purple-800">
                                        <p class="font-medium">Instant Virtual Card</p>
                                        <p class="mt-1">Create a secure virtual card for online purchases. The card will be ready immediately with full details.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button onclick="CardManager.createCard()" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Create Card
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            async createCard() {
                Utils.showLoading();
                try {
                    const data = await ApiService.post('/api/cards', {});
                    
                    // Close any open modals
                    document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
                    
                    Utils.showToast('Virtual card created successfully!', 'success');
                    
                    // Show card details modal
                    this.showCardDetailsModal(data.card);
                    
                    await DashboardManager.loadDashboardData();
                    DashboardManager.renderDashboard();
                    
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async showCardDetailsView(cardId) {
                AppState.currentView = 'cardDetails';
                Utils.showLoading();
                try {
                    const response = await ApiService.get(`/api/cards/${cardId}`);
                    this.renderCardDetailsView(response.card, response.transactions);
                } catch (error) {
                    Utils.showToast('Failed to load card details', 'error');
                    DashboardManager.initialize();
                } finally {
                    Utils.hideLoading();
                }
            },

            renderCardDetailsView(card, transactions) {
                const cardDetailsHTML = `
                    <div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8 fade-in">
                        <div class="px-4 py-6 sm:px-0">
                            <!-- Header -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <button onclick="DashboardManager.initialize()" 
                                                class="flex items-center space-x-2 text-purple-600 hover:text-purple-700 transition-colors duration-200 mb-2">
                                            <i class="fas fa-arrow-left"></i>
                                            <span>Back to Dashboard</span>
                                        </button>
                                        <h1 class="text-2xl font-bold text-gray-900">Card Details</h1>
                                        <p class="text-gray-600 mt-1">Manage your virtual card</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${card.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${card.status.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Card Preview -->
                                <div class="electric-border">
                                    <div class="new-card-design">
                                        <div class="new-card-header">
                                            <div class="new-card-balance">${Utils.formatCurrency(card.balance_cents)}</div>
                                        </div>
                                        <div class="new-card-body">
                                            <div class="new-card-field">
                                                <span class="new-card-label">Card number</span>
                                                <span class="new-card-value card-number-display">${Utils.maskCardNumber(card.card_number)}</span>
                                            </div>
                                            <div class="new-card-field">
                                                <span class="new-card-label">Name of the card holder</span>
                                                <span class="new-card-value">${card.card_owner || AppState.user.name}</span>
                                            </div>
                                            <div class="new-card-field">
                                                <span class="new-card-label">Sxpiry date</span>
                                                <span class="new-card-value">${Utils.formatCardDate(card.expiry_month, card.expiry_year)}</span>
                                            </div>
                                        </div>
                                        <div class="new-card-actions">
                                            <button onclick="CardManager.showFundCardModal('${card._id}')" 
                                                    class="new-card-btn">
                                                Addfund
                                            </button>
                                            <button onclick="CardManager.showCardDetailsView('${card._id}')" 
                                                    class="new-card-btn">
                                                Details
                                            </button>
                                            <button onclick="CardManager.showUpdateOwnerModal('${card._id}')" 
                                                    class="new-card-btn">
                                                Edit card
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card Information -->
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Card Information</h3>
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-600">Card Number:</span>
                                                <div class="font-mono font-semibold mt-1">${card.card_number}</div>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Expiry:</span>
                                                <div class="font-semibold mt-1">${Utils.formatCardDate(card.expiry_month, card.expiry_year)}</div>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">CVV:</span>
                                                <div class="font-mono font-semibold mt-1">${card.cvv}</div>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Balance:</span>
                                                <div class="font-semibold mt-1">${Utils.formatCurrency(card.balance_cents)}</div>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Type:</span>
                                                <div class="font-semibold mt-1">${card.card_type}</div>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Network:</span>
                                                <div class="font-semibold mt-1 capitalize">${card.card_network}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="border-t pt-4">
                                            <h4 class="text-md font-semibold text-gray-900 mb-3">Billing Address</h4>
                                            <div class="text-sm text-gray-600">
                                                <div>${card.billing_address.street}</div>
                                                <div>${card.billing_address.city}, ${card.billing_address.state} ${card.billing_address.zip_code}</div>
                                                <div>${card.billing_address.country}</div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3 pt-4">
                                            <button onclick="CardManager.showFundCardModal('${card._id}')" 
                                                    class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm">
                                                Add Funds
                                            </button>
                                            <button onclick="CardManager.showCardTransferModal('${card._id}')" 
                                                    class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm">
                                                Transfer
                                            </button>
                                            <button onclick="CardManager.toggleCardBlock('${card._id}')" 
                                                    class="bg-${card.status === 'active' ? 'red' : 'green'}-600 text-white py-2 px-4 rounded-lg hover:bg-${card.status === 'active' ? 'red' : 'green'}-700 transition-colors duration-200 text-sm">
                                                ${card.status === 'active' ? 'Block Card' : 'Unblock Card'}
                                            </button>
                                            <button onclick="CardManager.showCardTransactions('${card._id}')" 
                                                    class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 text-sm">
                                                View Transactions
                                            </button>
                                        </div>
                                        
                                        <div class="border-t pt-4">
                                            <button onclick="CardManager.deleteCard('${card._id}')" 
                                                    class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors duration-200 font-medium">
                                                <i class="fas fa-trash mr-2"></i>Delete Card
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Transactions -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mt-8">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3>
                                        <button onclick="CardManager.showCardTransactions('${card._id}')" 
                                                class="text-purple-600 hover:text-purple-500 text-sm font-medium">
                                            View All
                                        </button>
                                    </div>
                                </div>
                                <div class="divide-y divide-gray-200">
                                    ${this.renderCardTransactions(transactions.slice(0, 5))}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = cardDetailsHTML;
            },

            showUpdateOwnerModal(cardId) {
                const card = AppState.cards.find(c => c._id === cardId);
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Update Card Owner Name</h3>
                        </div>
                        <form id="updateOwnerForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Card Holder Name</label>
                                <input type="text" value="${card.card_owner || AppState.user.name}" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter card holder name">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Update Name
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#updateOwnerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const cardOwner = e.target.querySelector('input[type="text"]').value;

                    Utils.showLoading();
                    try {
                        await ApiService.put(`/api/cards/${cardId}`, {
                            card_owner: cardOwner
                        });

                        Utils.showToast('Card owner name updated successfully!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        if (AppState.currentView === 'cardDetails') {
                            this.showCardDetailsView(cardId);
                        } else {
                            DashboardManager.renderDashboard();
                        }
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            async showCardTransactions(cardId) {
                Utils.showLoading();
                try {
                    const response = await ApiService.get(`/api/cards/${cardId}/transactions`);
                    this.renderCardTransactionsView(cardId, response.transactions);
                } catch (error) {
                    Utils.showToast('Failed to load card transactions', 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            renderCardTransactionsView(cardId, transactions) {
                const card = AppState.cards.find(c => c._id === cardId);
                const transactionsHTML = `
                    <div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8 fade-in">
                        <div class="px-4 py-6 sm:px-0">
                            <!-- Header -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <button onclick="CardManager.showCardDetailsView('${cardId}')" 
                                                class="flex items-center space-x-2 text-purple-600 hover:text-purple-700 transition-colors duration-200 mb-2">
                                            <i class="fas fa-arrow-left"></i>
                                            <span>Back to Card Details</span>
                                        </button>
                                        <h1 class="text-2xl font-bold text-gray-900">Card Transactions</h1>
                                        <p class="text-gray-600 mt-1">${Utils.maskCardNumber(card.card_number)}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Transactions List -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-900">All Transactions</h3>
                                </div>
                                <div class="divide-y divide-gray-200">
                                    ${this.renderCardTransactions(transactions)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = transactionsHTML;
            },

            renderCardTransactions(transactions) {
                if (!transactions || transactions.length === 0) {
                    return `
                        <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                            <i class="fas fa-receipt text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg">No transactions yet</p>
                            <p class="text-sm mt-1">Card transactions will appear here</p>
                        </div>
                    `;
                }

                return transactions.map(transaction => `
                    <div class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0 ${transaction.amount_cents > 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} rounded-lg p-2">
                                    <i class="fas ${transaction.amount_cents > 0 ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">
                                        ${transaction.description || 'Card Transaction'}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ${Utils.formatDate(transaction.created_at)}
                                        ${transaction.counterparty_card ? `• To Card ${transaction.counterparty_card}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold ${transaction.amount_cents > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${transaction.amount_cents > 0 ? '+' : ''}${Utils.formatCurrency(transaction.amount_cents)}
                                </div>
                                <div class="text-xs text-gray-500 capitalize">${transaction.status}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            showFundCardModal(cardId) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Add Funds to Card</h3>
                        </div>
                        <form id="fundCardForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Add Funds
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#fundCardForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amount = parseFloat(e.target.querySelector('input[type="number"]').value);

                    if (amount <= 0) {
                        Utils.showToast('Please enter a valid amount', 'error');
                        return;
                    }

                    Utils.showLoading();
                    try {
                        await ApiService.post(`/api/cards/${cardId}/fund`, {
                            amount_cents: Math.round(amount * 100)
                        });

                        Utils.showToast('Card funded successfully!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        if (AppState.currentView === 'cardDetails' || AppState.currentView === 'cardTransactions') {
                            this.showCardDetailsView(cardId);
                        } else {
                            DashboardManager.renderDashboard();
                        }
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            showCardTransferModal(fromCardId) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Transfer Money</h3>
                        </div>
                        <form id="cardTransferForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Transfer Type</label>
                                <select id="transferType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="card">To Another Card</option>
                                    <option value="bank">To Bank Account</option>
                                </select>
                            </div>

                            <div id="cardFields">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Destination Card Number</label>
                                    <input type="text" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent card-number-input"
                                           placeholder="Enter 16-digit card number">
                                    <div class="text-xs text-gray-500 mt-1 card-validation-message"></div>
                                </div>
                            </div>

                            <div id="bankFields" class="hidden">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bank Account Number</label>
                                    <input type="text" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                           placeholder="Enter account number">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Routing Number</label>
                                    <input type="text" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                           placeholder="Enter routing number">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                                <input type="text"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="e.g., Payment">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Transfer
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Transfer type toggle
                const transferType = modal.querySelector('#transferType');
                const cardFields = modal.querySelector('#cardFields');
                const bankFields = modal.querySelector('#bankFields');

                transferType.addEventListener('change', (e) => {
                    if (e.target.value === 'card') {
                        cardFields.classList.remove('hidden');
                        bankFields.classList.add('hidden');
                    } else {
                        cardFields.classList.add('hidden');
                        bankFields.classList.remove('hidden');
                    }
                });

                // Card number validation
                const cardInput = modal.querySelector('.card-number-input');
                const validationMessage = modal.querySelector('.card-validation-message');

                cardInput.addEventListener('input', (e) => {
                    const cardNumber = e.target.value.replace(/\s/g, '');
                    if (cardNumber.length === 16) {
                        if (Utils.validateCardNumber(cardNumber)) {
                            validationMessage.textContent = '✓ Valid card number';
                            validationMessage.className = 'text-xs text-green-600 mt-1';
                        } else {
                            validationMessage.textContent = '✗ Invalid card number';
                            validationMessage.className = 'text-xs text-red-600 mt-1';
                        }
                    } else {
                        validationMessage.textContent = '';
                    }
                });

                modal.querySelector('#cardTransferForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const transferType = modal.querySelector('#transferType').value;
                    const amount = parseFloat(e.target.querySelector('input[type="number"]').value);
                    const description = e.target.querySelector('input[type="text"][placeholder*="Description"]').value;

                    if (amount <= 0) {
                        Utils.showToast('Please enter a valid amount', 'error');
                        return;
                    }

                    Utils.showLoading();
                    try {
                        if (transferType === 'card') {
                            const to_card_number = modal.querySelector('.card-number-input').value.replace(/\s/g, '');
                            
                            if (!Utils.validateCardNumber(to_card_number)) {
                                Utils.showToast('Please enter a valid 16-digit card number', 'error');
                                Utils.hideLoading();
                                return;
                            }

                            await ApiService.post('/api/cards/transfer', {
                                from_card_id: fromCardId,
                                to_card_number: to_card_number,
                                amount_cents: Math.round(amount * 100),
                                description
                            });

                            Utils.showToast('Card transfer successful!', 'success');
                        } else {
                            const account_number = modal.querySelector('#bankFields input:nth-child(1)').value;
                            const routing_number = modal.querySelector('#bankFields input:nth-child(2)').value;

                            await ApiService.post('/api/cards/transfer-to-bank', {
                                card_id: fromCardId,
                                account_number: account_number,
                                routing_number: routing_number,
                                amount_cents: Math.round(amount * 100),
                                description
                            });

                            Utils.showToast('Bank transfer successful!', 'success');
                        }

                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        if (AppState.currentView === 'cardDetails' || AppState.currentView === 'cardTransactions') {
                            this.showCardDetailsView(fromCardId);
                        } else {
                            DashboardManager.renderDashboard();
                        }
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            showCardDetailsModal(card) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Card Created Successfully!</h3>
                        </div>
                        <div class="p-6">
                            <div class="electric-border mb-4">
                                <div class="new-card-design">
                                    <div class="new-card-header">
                                        <div class="new-card-balance">${Utils.formatCurrency(card.balance_cents)}</div>
                                    </div>
                                    <div class="new-card-body">
                                        <div class="new-card-field">
                                            <span class="new-card-label">Card number</span>
                                            <span class="new-card-value card-number-display">${Utils.maskCardNumber(card.card_number)}</span>
                                        </div>
                                        <div class="new-card-field">
                                            <span class="new-card-label">Name of the card holder</span>
                                            <span class="new-card-value">${card.card_owner || AppState.user.name}</span>
                                        </div>
                                        <div class="new-card-field">
                                            <span class="new-card-label">Sxpiry date</span>
                                            <span class="new-card-value">${Utils.formatCardDate(card.expiry_month, card.expiry_year)}</span>
                                        </div>
                                    </div>
                                    <div class="new-card-actions">
                                        <button class="new-card-btn">
                                            Addfund
                                        </button>
                                        <button class="new-card-btn">
                                            Details
                                        </button>
                                        <button class="new-card-btn">
                                            Edit card
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                                    <div class="text-sm text-yellow-800">
                                        <p class="font-medium">Save your card details</p>
                                        <p class="mt-1">For security reasons, we won't show the full card number again. Make sure to save it somewhere safe.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <span class="text-gray-600">Card Number:</span>
                                    <div class="font-mono font-semibold">${card.card_number}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">CVV:</span>
                                    <div class="font-mono font-semibold">${card.cvv}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Expiry:</span>
                                    <div class="font-semibold">${Utils.formatCardDate(card.expiry_month, card.expiry_year)}</div>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 mt-6">
                                Got it!
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            async toggleCardBlock(cardId) {
                Utils.showLoading();
                try {
                    const response = await ApiService.post(`/api/cards/${cardId}/block`);
                    Utils.showToast(`Card ${response.card.status === 'active' ? 'unblocked' : 'blocked'} successfully!`, 'success');
                    await DashboardManager.loadDashboardData();
                    this.showCardDetailsView(cardId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async deleteCard(cardId) {
                if (!confirm('Are you sure you want to delete this card? Any remaining balance will be returned to your account.')) {
                    return;
                }

                Utils.showLoading();
                try {
                    await ApiService.delete(`/api/cards/${cardId}`);
                    Utils.showToast('Card deleted successfully!', 'success');
                    await DashboardManager.loadDashboardData();
                    DashboardManager.initialize();
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        };

        // Organization Management
        const OrganizationManager = {
            async showOrganizations() {
                AppState.currentView = 'organizations';
                Utils.showLoading();
                try {
                    const response = await ApiService.get('/api/organizations/all');
                    this.renderOrganizationsView(response.organizations);
                } catch (error) {
                    Utils.showToast('Failed to load organizations', 'error');
                    DashboardManager.initialize();
                } finally {
                    Utils.hideLoading();
                }
            },

            renderOrganizationsView(organizations) {
                const organizationsHTML = `
                    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 fade-in">
                        <div class="px-4 py-6 sm:px-0">
                            <!-- Header -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <button onclick="DashboardManager.initialize()" 
                                                class="flex items-center space-x-2 text-purple-600 hover:text-purple-700 transition-colors duration-200 mb-2">
                                            <i class="fas fa-arrow-left"></i>
                                            <span>Back to Dashboard</span>
                                        </button>
                                        <h1 class="text-2xl font-bold text-gray-900">Organizations</h1>
                                        <p class="text-gray-600 mt-1">Browse and manage organizations</p>
                                    </div>
                                    <button onclick="OrganizationManager.showCreateOrganizationModal()" 
                                            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                        Create Organization
                                    </button>
                                </div>
                            </div>

                            <!-- Organizations Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${organizations.map(org => `
                                    <div class="organization-card p-6 cursor-pointer" onclick="OrganizationManager.showOrganizationDetails('${org._id}')">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 class="text-xl font-bold">${org.name}</h3>
                                                <p class="text-sm opacity-80 mt-1">${org.description || 'No description'}</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm opacity-80">${org.members.length} members</div>
                                                <div class="text-xs mt-1 ${org.owner_id === AppState.user._id ? 'bg-yellow-500 text-white px-2 py-1 rounded' : ''}">
                                                    ${org.owner_id === AppState.user._id ? 'Owner' : 'View Only'}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center text-sm">
                                            <span>Created ${new Date(org.created_at).toLocaleDateString()}</span>
                                            <button onclick="event.stopPropagation(); OrganizationManager.joinOrganization('${org._id}')" 
                                                    class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded transition-all duration-200">
                                                Join
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            ${!organizations.length ? `
                                <div class="text-center py-12">
                                    <i class="fas fa-building text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Organizations Yet</h3>
                                    <p class="text-gray-600 mb-4">Be the first to create an organization!</p>
                                    <button onclick="OrganizationManager.showCreateOrganizationModal()" 
                                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                        Create First Organization
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = organizationsHTML;
            },

            showCreateOrganizationModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Create Organization</h3>
                        </div>
                        <form id="createOrganizationForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                                <input type="text" name="name" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter organization name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="3"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Describe your organization"></textarea>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Create
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#createOrganizationForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);

                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/organizations', {
                            name: formData.get('name'),
                            description: formData.get('description')
                        });

                        Utils.showToast('Organization created successfully!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        if (AppState.currentView === 'organizations') {
                            this.showOrganizations();
                        } else {
                            DashboardManager.renderDashboard();
                        }
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            async showOrganizationDetails(orgId) {
                Utils.showLoading();
                try {
                    const response = await ApiService.get(`/api/organizations/${orgId}`);
                    this.renderOrganizationDetails(response.organization);
                } catch (error) {
                    Utils.showToast('Failed to load organization details', 'error');
                    this.showOrganizations();
                } finally {
                    Utils.hideLoading();
                }
            },

            renderOrganizationDetails(org) {
                const isOwner = org.owner_id === AppState.user._id;
                const isMember = org.members.some(member => member.user_id === AppState.user._id);
                const currentUserMember = org.members.find(member => member.user_id === AppState.user._id);

                const orgDetailsHTML = `
                    <div class="max-w-6xl mx-auto py-6 sm:px-6 lg:px-8 fade-in">
                        <div class="px-4 py-6 sm:px-0">
                            <!-- Header -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <button onclick="OrganizationManager.showOrganizations()" 
                                                class="flex items-center space-x-2 text-purple-600 hover:text-purple-700 transition-colors duration-200 mb-2">
                                            <i class="fas fa-arrow-left"></i>
                                            <span>Back to Organizations</span>
                                        </button>
                                        <h1 class="text-2xl font-bold text-gray-900">${org.name}</h1>
                                        <p class="text-gray-600 mt-1">${org.description || 'No description'}</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        ${isOwner ? `
                                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                                Owner
                                            </span>
                                        ` : isMember ? `
                                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                                ${currentUserMember?.role || 'Member'}
                                            </span>
                                        ` : `
                                            <button onclick="OrganizationManager.requestToJoin('${org._id}')" 
                                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                                Request to Join
                                            </button>
                                        `}
                                        ${isOwner && `
                                            <button onclick="OrganizationManager.showOrganizationCards('${org._id}')" 
                                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                                Manage Cards
                                            </button>
                                        `}
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Organization Info & Cards -->
                                <div class="lg:col-span-2 space-y-8">
                                    <!-- Organization Info -->
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Organization Information</h3>
                                        <div class="space-y-4">
                                            <div class="grid grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <span class="text-gray-600">Created:</span>
                                                    <div class="font-semibold mt-1">${new Date(org.created_at).toLocaleDateString()}</div>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Members:</span>
                                                    <div class="font-semibold mt-1">${org.members.length} people</div>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Status:</span>
                                                    <div class="font-semibold mt-1 capitalize">${org.status}</div>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Visibility:</span>
                                                    <div class="font-semibold mt-1 capitalize">${org.visibility}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Organization Cards -->
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                            <h3 class="text-lg font-semibold text-gray-900">Organization Cards</h3>
                                            ${isOwner && `
                                                <button onclick="OrganizationManager.createOrganizationCard('${org._id}')" 
                                                        class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors duration-200">
                                                    + New Card
                                                </button>
                                            `}
                                        </div>
                                        <div class="p-6">
                                            ${org.cards && org.cards.length > 0 ? 
                                                org.cards.map(card => `
                                                    <div class="electric-border p-4 mb-3">
                                                        <div class="new-card-design">
                                                            <div class="new-card-header">
                                                                <div class="new-card-balance">${Utils.formatCurrency(card.balance_cents)}</div>
                                                            </div>
                                                            <div class="new-card-body">
                                                                <div class="new-card-field">
                                                                    <span class="new-card-label">Card number</span>
                                                                    <span class="new-card-value card-number-display">${Utils.maskCardNumber(card.card_number)}</span>
                                                                </div>
                                                            </div>
                                                            ${isOwner && `
                                                                <div class="new-card-actions">
                                                                    <button onclick="OrganizationManager.deleteOrganizationCard('${org._id}', '${card._id}')" 
                                                                            class="new-card-btn bg-red-600 hover:bg-red-700">
                                                                        Delete
                                                                    </button>
                                                                </div>
                                                            `}
                                                        </div>
                                                    </div>
                                                `).join('') : `
                                                <div class="text-center text-gray-500 py-8">
                                                    <i class="fas fa-credit-card text-3xl mb-3"></i>
                                                    <p>No organization cards yet</p>
                                                    ${isOwner && `
                                                        <p class="text-sm mt-1">Create cards for organization expenses</p>
                                                    `}
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                </div>

                                <!-- Members Section -->
                                <div class="space-y-6">
                                    <!-- Members List -->
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Organization Members</h3>
                                        <div class="space-y-3">
                                            ${org.members.map(member => `
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                                            <i class="fas fa-user text-purple-600 text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-medium text-sm">${member.name}</div>
                                                            <div class="text-xs text-gray-500">${member.role}</div>
                                                        </div>
                                                    </div>
                                                    ${isOwner && member.user_id !== org.owner_id && `
                                                        <div class="flex space-x-1">
                                                            <button onclick="OrganizationManager.changeMemberRole('${org._id}', '${member.user_id}', 'manager')" 
                                                                    class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition-colors duration-200">
                                                                Make Manager
                                                            </button>
                                                            <button onclick="OrganizationManager.removeMember('${org._id}', '${member.user_id}')" 
                                                                    class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 transition-colors duration-200">
                                                                Remove
                                                            </button>
                                                        </div>
                                                    `}
                                                    ${member.user_id === org.owner_id ? `
                                                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Owner</span>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>

                                        <!-- Pending Join Requests -->
                                        ${org.pending_requests && org.pending_requests.length > 0 && isOwner && `
                                            <div class="mt-6 pt-4 border-t">
                                                <h4 class="text-md font-semibold text-gray-900 mb-3">Pending Join Requests</h4>
                                                <div class="space-y-2">
                                                    ${org.pending_requests.map(request => `
                                                        <div class="flex items-center justify-between p-2 bg-yellow-50 rounded">
                                                            <div class="flex items-center space-x-2">
                                                                <i class="fas fa-clock text-yellow-600"></i>
                                                                <span class="text-sm">${request.user_name} (${request.user_email})</span>
                                                            </div>
                                                            <div class="flex space-x-1">
                                                                <button onclick="OrganizationManager.approveJoinRequest('${org._id}', '${request.user_id}')" 
                                                                        class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                                                                    Approve
                                                                </button>
                                                                <button onclick="OrganizationManager.rejectJoinRequest('${org._id}', '${request.user_id}')" 
                                                                        class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                                                                    Reject
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `}

                                        ${isOwner ? `
                                            <div class="mt-6 pt-4 border-t">
                                                <button onclick="OrganizationManager.showInviteModal('${org._id}')" 
                                                        class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                                    Invite Members
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- Organization Transactions -->
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3>
                                        </div>
                                        <div class="p-6">
                                            <div class="text-center text-gray-500 py-8">
                                                <i class="fas fa-exchange-alt text-3xl mb-3"></i>
                                                <p>Organization transaction history</p>
                                                <p class="text-sm mt-1">View all card transfers and expenses</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                elements.mainContent.innerHTML = orgDetailsHTML;
            },

            async requestToJoin(orgId) {
                Utils.showLoading();
                try {
                    await ApiService.post(`/api/organizations/${orgId}/request-join`);
                    Utils.showToast('Join request sent! Waiting for owner approval.', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async approveJoinRequest(orgId, userId) {
                Utils.showLoading();
                try {
                    await ApiService.post(`/api/organizations/${orgId}/approve-request`, { user_id: userId });
                    Utils.showToast('Join request approved!', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async rejectJoinRequest(orgId, userId) {
                Utils.showLoading();
                try {
                    await ApiService.post(`/api/organizations/${orgId}/reject-request`, { user_id: userId });
                    Utils.showToast('Join request rejected!', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async changeMemberRole(orgId, userId, newRole) {
                Utils.showLoading();
                try {
                    await ApiService.put(`/api/organizations/${orgId}/member-role`, {
                        user_id: userId,
                        new_role: newRole
                    });
                    Utils.showToast('Member role updated successfully!', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async removeMember(orgId, userId) {
                if (!confirm('Are you sure you want to remove this member?')) {
                    return;
                }

                Utils.showLoading();
                try {
                    await ApiService.delete(`/api/organizations/${orgId}/members/${userId}`);
                    Utils.showToast('Member removed successfully!', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async createOrganizationCard(orgId) {
                Utils.showLoading();
                try {
                    await ApiService.post(`/api/organizations/${orgId}/cards`);
                    Utils.showToast('Organization card created successfully!', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async deleteOrganizationCard(orgId, cardId) {
                if (!confirm('Are you sure you want to delete this organization card?')) {
                    return;
                }

                Utils.showLoading();
                try {
                    await ApiService.delete(`/api/organizations/${orgId}/cards/${cardId}`);
                    Utils.showToast('Organization card deleted successfully!', 'success');
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            async joinOrganization(orgId) {
                Utils.showLoading();
                try {
                    await ApiService.post(`/api/organizations/${orgId}/join`);
                    Utils.showToast('Successfully joined the organization!', 'success');
                    await DashboardManager.loadDashboardData();
                    this.showOrganizationDetails(orgId);
                } catch (error) {
                    Utils.showToast(error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            },

            showInviteModal(orgId) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Invite Members</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-600 mb-4">Share this code with people you want to invite:</p>
                            <div class="bg-gray-100 p-4 rounded-lg text-center mb-4">
                                <div class="font-mono text-lg font-bold">ORG-${orgId.slice(-8).toUpperCase()}</div>
                                <p class="text-sm text-gray-500 mt-1">Share this code to invite members</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            showOrganizationCards(orgId) {
                // This would show a detailed view of organization cards
                Utils.showToast('Organization cards management view', 'info');
            }
        };

        // Payment Management
        const PaymentManager = {
            showPaymentModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Make a Payment</h3>
                        </div>
                        <form id="paymentForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                                <input type="text" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent card-number-input"
                                       placeholder="1234 5678 9012 3456">
                                <div class="text-xs text-gray-500 mt-1 card-validation-message"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                                    <input type="text" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                           placeholder="MM/YY">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                                    <input type="text" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                           placeholder="123">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Merchant/Description</label>
                                <input type="text" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="e.g., Amazon Purchase">
                            </div>

                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Process Payment
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Card number validation
                const cardInput = modal.querySelector('.card-number-input');
                const validationMessage = modal.querySelector('.card-validation-message');

                cardInput.addEventListener('input', (e) => {
                    const cardNumber = e.target.value.replace(/\s/g, '');
                    if (cardNumber.length === 16) {
                        if (Utils.validateCardNumber(cardNumber)) {
                            validationMessage.textContent = '✓ Valid card number';
                            validationMessage.className = 'text-xs text-green-600 mt-1';
                        } else {
                            validationMessage.textContent = '✗ Invalid card number';
                            validationMessage.className = 'text-xs text-red-600 mt-1';
                        }
                    } else {
                        validationMessage.textContent = '';
                    }
                });

                modal.querySelector('#paymentForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const cardNumber = formData.get('card_number').replace(/\s/g, '');
                    const amount = parseFloat(formData.get('amount'));
                    const description = formData.get('description');

                    if (!Utils.validateCardNumber(cardNumber)) {
                        Utils.showToast('Please enter a valid card number', 'error');
                        return;
                    }

                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/payments/process', {
                            card_number: cardNumber,
                            amount_cents: Math.round(amount * 100),
                            description: description
                        });

                        Utils.showToast('Payment processed successfully!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        DashboardManager.renderDashboard();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            }
        };

        // Transfer Management
        const TransferManager = {
            showExternalTransferModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">External Bank Transfer</h3>
                        </div>
                        <form id="externalTransferForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Name</label>
                                <input type="text" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter recipient full name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bank Account Number</label>
                                <input type="text" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter account number">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Routing Number</label>
                                <input type="text" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter routing number">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                                <input type="text"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="e.g., Payment for services">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Transfer
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#externalTransferForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const recipient_name = formData.get('recipient_name');
                    const account_number = formData.get('account_number');
                    const routing_number = formData.get('routing_number');
                    const amount = parseFloat(formData.get('amount'));
                    const description = formData.get('description');

                    if (amount <= 0) {
                        Utils.showToast('Please enter a valid amount', 'error');
                        return;
                    }

                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/transfers/external', {
                            amount_cents: Math.round(amount * 100),
                            recipient_name: recipient_name,
                            recipient_account_number: account_number,
                            routing_number: routing_number,
                            description: description || `External transfer to ${recipient_name}`
                        });

                        Utils.showToast('External transfer completed successfully!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        DashboardManager.renderDashboard();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            },

            showCardToBankTransferModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full slide-up">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Transfer from Card to Bank</h3>
                        </div>
                        <form id="cardToBankForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Card</label>
                                <select required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">Choose a card</option>
                                    ${AppState.cards.map(card => `
                                        <option value="${card._id}">${Utils.maskCardNumber(card.card_number)} - Balance: ${Utils.formatCurrency(card.balance_cents)}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bank Account Number</label>
                                <input type="text" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter account number">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Routing Number</label>
                                <input type="text" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Enter routing number">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (USD)</label>
                                <input type="number" step="0.01" min="0.01" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="0.00">
                            </div>

                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium">
                                    Transfer
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('#cardToBankForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const cardId = formData.get('card_id');
                    const amount = parseFloat(formData.get('amount'));
                    const accountNumber = formData.get('account_number');
                    const routingNumber = formData.get('routing_number');

                    Utils.showLoading();
                    try {
                        await ApiService.post('/api/cards/transfer-to-bank', {
                            card_id: cardId,
                            account_number: accountNumber,
                            routing_number: routingNumber,
                            amount_cents: Math.round(amount * 100)
                        });

                        Utils.showToast('Transfer to bank completed successfully!', 'success');
                        modal.remove();
                        await DashboardManager.loadDashboardData();
                        DashboardManager.renderDashboard();
                    } catch (error) {
                        Utils.showToast(error.message, 'error');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            }
        };

        // Socket Management
        const SocketManager = {
            initialize() {
                if (AppState.socket) {
                    AppState.socket.disconnect();
                }

                AppState.socket = io();

                AppState.socket.on('connect', () => {
                    console.log('WebSocket connected');
                    AppState.socket.emit('authenticate', AppState.token);
                });

                AppState.socket.on('balance_update', (data) => {
                    AppState.currentBalance = data.balance_cents;
                    const balanceDisplay = document.getElementById('balanceDisplay');
                    if (balanceDisplay) {
                        balanceDisplay.textContent = Utils.formatCurrency(data.balance_cents);
                    }
                    Utils.showToast('Balance updated', 'info');
                });

                AppState.socket.on('disconnect', () => {
                    console.log('WebSocket disconnected');
                });
            }
        };

        // Application Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if we have a token and if the session is still valid
            if (AppState.token) {
                Utils.showLoading();
                try {
                    const sessionValid = await AuthManager.checkSession();
                    if (sessionValid) {
                        await DashboardManager.initialize();
                    } else {
                        localStorage.removeItem('authToken');
                        AuthManager.renderAuthScreen();
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                    localStorage.removeItem('authToken');
                    AuthManager.renderAuthScreen();
                } finally {
                    Utils.hideLoading();
                }
            } else {
                AuthManager.renderAuthScreen();
            }
        });

        // Make managers globally available
        window.AuthManager = AuthManager;
        window.DashboardManager = DashboardManager;
        window.CardManager = CardManager;
        window.ProfileManager = ProfileManager;
        window.OrganizationManager = OrganizationManager;
        window.PaymentManager = PaymentManager;
        window.TransferManager = TransferManager;
    </script>
</body>
</html>
